---
title: "Actualizacion de ecuacion V desconocida"
output: pdf_document
date: "2022-08-17"
---
\fontsize{15}{15}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(LaplacesDemon)
options(digits=4)
```

```{r}
#A. Posterior en t=19
m19 <- c(1.5, 1.8, -0.7)
C19 <- matrix(c(0.00002, 0.00001, -0.00002, 0.00001, 0.00003, -0.00001, -0.00002, 
                -0.00001, 0.00002), ncol = 3)

#Valores conocidos de G20 y W20
G20 <- matrix(c(1.001, 0, 0, 0, 1, 0, 0, 0, 1), ncol=3)
W20 <- matrix(c(0.00001, 0, 0, 0, 0.00001, -0.00001, 0, -0.00001, 0.00005), ncol=3)

#B. Priori de parámetros en t=20
a20 <- G20 %*% m19
R20 <- G20 %*% C19 %*% t(G20) + W20
a20
R20
```



```{r}
freeny[20,]
F20 <- c(1, 6.06093, 4.51018) #Variables explicativas en t=20. El 1 es para
                              #agregar el intercepto
S19 <- 0.00005 # Estimación de V en T=19
n19 <- 19.5 # Grados de libertad
#C. Pronóstico a un periodo.
f20 <- as.numeric(t(F20) %*% a20)
Q20 <- as.numeric(t(F20) %*% R20 %*% F20 + S19)
f20
Q20
```


```{r}
c(qst(0.025, nu = n19, mu = f20, sigma = sqrt(Q20)),
  qst(0.975, nu = n19, mu = f20, sigma = sqrt(Q20)))
```

```{r}
#Valor observado de Y20:
Y20 <- 9.31378
#D. Posterior en t=20
A20 <- R20 %*% F20 / Q20
e20 <- Y20-f20
m20 <- a20 + A20 %*% e20
n20 <- n19 + 1
S20 <- S19 + (S19/n20)*(e20^2/Q20-1)
C20 <- (S20/S19)*(R20-A20 %*% t(A20) * Q20)
m20
C20
```


```{r}
datos_ej <- freeny %>% 
  mutate(intercept = 1) %>% 
  slice(20:n()) %>% 
  dplyr::select(y, intercept, income.level, price.index)

#Se asume que Gt, Vt y Wt son ctes conocidas para toda t.
actualizacion_V_desc <- function(datos, m0, C0, G, W, S0, n0){
  mt_menos_1 <- m0
  Ct_menos_1 <- C0
  St_menos_1 <- S0
  nt_menos_1 <- n0
  lista_at <- list()
  lista_Rt <- list()
  lista_ft <- list()
  lista_Qt <- list()
  lista_mt <- list()
  lista_Ct <- list()
  lista_CI <- list()
  lista_CI_inf <- list()
  lista_CI_sup <- list()
  lista_St <- list()
  for(t in 1:length(datos$y)){
    at <- G %*% mt_menos_1
    Rt <- G %*% Ct_menos_1 %*% t(G) + W
    Ft <- as.numeric(datos[t, 2:4])
    ft <- t(Ft) %*% at
    Qt <- t(Ft) %*% Rt %*% Ft + St_menos_1
    CI <- c(qst(0.025, nu = nt_menos_1, mu = ft, sigma = sqrt(Qt)),
            qst(0.975, nu = nt_menos_1, mu = ft, sigma = sqrt(Qt)))
    CI_inf <- CI[1]
    CI_sup <- CI[2]
    Yt <- datos[t,1]
    At = Rt %*% Ft %*% solve(Qt)
    et = Yt-ft
    mt = at + At %*% et
    nt <- nt_menos_1 + 1
    St <- as.numeric(St_menos_1 + (St_menos_1/nt) * (e20^2 %*% solve(Qt) - 1))
    Ct <- (St/St_menos_1)*(Rt - At %*% Qt %*% t(At))
    lista_at[[t]] <- at
    lista_Rt[[t]] <- Rt
    lista_ft[[t]] <- ft
    lista_Qt[[t]] <- Qt
    lista_CI[[t]] <- CI
    lista_CI_inf[[t]] <- CI_inf
    lista_CI_sup[[t]] <- CI_sup
    lista_mt[[t]] <- mt
    lista_Ct[[t]] <- Ct
    lista_St[[t]] <- St
    mt_menos_1 <- mt
    Ct_menos_1 <- Ct
    nt_menos_1 <- nt
    St_menos_1 <- St
  }
  return(list("at" = lista_at, "Rt" = lista_Rt, "ft" = lista_ft, 
              "Qt" = lista_Qt, "CI" = lista_CI, "CI_inf" = lista_CI_inf, 
              "CI_sup" = lista_CI_sup, "mt" = lista_mt, "Ct" = lista_Ct,
              "St" = lista_St))
}
```


```{r}
res_dlm <- actualizacion_V_desc(datos_ej, m19, C19, G20, W20, S19, n19)
```


```{r}
df_graficas <- data.frame("fecha" = datos_ej %>% row.names(), "y_real" = datos_ej$y, 
           "y_pronostico" = res_dlm$ft %>% unlist(), "CI_inf" = res_dlm$CI_inf %>% unlist(),
           "CI_sup" = res_dlm$CI_sup %>% unlist()) %>% 
  mutate(fecha = as.numeric(fecha))
```


```{r}
ggplot(data = df_graficas, aes(x = fecha)) +
  geom_point(aes(y = y_real, shape = "Observaciones")) +
  geom_line(aes(y = y_pronostico, color = 'Pronósticos')) +
  geom_line(aes(y = CI_inf), color = "blue", alpha = 0.3) +
  geom_line(aes(y = CI_sup), color = "blue", alpha = 0.3) + 
  geom_ribbon(aes(ymax = CI_sup, ymin = CI_inf, fill = 'Intervalo'), alpha = 0.3) +
  theme_bw() +
  scale_colour_manual(
    name = "", values = c("Intervalo" = "transparent",
                          "Pronósticos" = "black")) +
  scale_fill_manual(
    name = "",  values = c("Intervalo" = "blue",
                           "Pronósticos" = "transparent")) +
  theme(legend.position = "bottom") +
  labs(shape = "") +
  ylab('Ventas') +
  xlab('Fecha')
```


```{r}
df_params <- data.frame(reduce(res_dlm$mt, cbind) %>% t(), fecha = df_graficas$fecha)  %>% 
  rename(Intercepto = X1, Ingreso = X2, Precio = X3) %>% 
  pivot_longer(names_to = "parametro", values_to = "valor", 
               cols = c(Intercepto, Ingreso, Precio))
```

```{r}
ggplot(df_params, aes(x=fecha, y = valor)) +
  geom_line() +
  facet_wrap(~parametro, nrow = 3, scales = "free") +
  theme_bw()  +
  ylab("Valor") +
  xlab("Fecha")
```

```{r}
df_St <- data.frame(res_dlm$St %>% unlist(), fecha = df_graficas$fecha) %>% 
  rename(St = 1)
```

```{r}
ggplot(df_St, aes(x=fecha, y = St)) +
  geom_line() +
  theme_bw()  +
  ylab("St") +
  xlab("Fecha")
```


Distribuciones filtradas

```{r}
B19 <- C19 %*% t(G20) %*% solve(R20)
a20_menos_1 <- m19 + B19 %*% (m20 - a20)
R20_menos_1 <- C19 - B19 %*% (C20 - R20) %*% solve(B19)

a20_menos_1

S20/S19 * R20_menos_1
```


```{r}
freeny[19,]
```


```{r}
F19 <- c(1, 6.05563	, 4.53957) #Variables explicativas en t=19. El 1 es para
                              #agregar el intercepto
t(F19) %*% a20_menos_1

S20/S19 * t(F19) %*% R20_menos_1 %*% F19
```


